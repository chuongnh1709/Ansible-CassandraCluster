---
  - hosts: cnode*
    gather_facts: yes
    become: yes
    vars:
      cassandra_admin_user: "admin"
      cassandra_admin_user_pwd: "BigSecret"
      limits: [
        "root soft memlock unlimited",
        "root hard memlock unlimited",
        "root – nofile 100000",
        "root – nproc 32768",
        "root – as unlimited" ]

    tasks:

      - name: Output a debug message
        debug:
          msg: "Anisble debug task is excuted!"
          verbosity: 1

      - name: Set FQDN
        lineinfile:
          dest: /etc/hostname
          regexp: "^{{ ansible_nodename }}*"
          line: "{{ ansible_nodename }}.local"
        register: fqdn_set
        when: '"local" not in "{{ ansible_hostname }}"'

      - name: Restart network
        service:
          name: network
          state: restarted
        when: fqdn_set.changed

      - name: Disable Swap
        command: swapoff -a

      - name: Remove swap partitions
        mount:
          path: swap
          state: absent

      - name: Ensure Swappiness is 0
        sysctl:
          name: vm.swappiness
          value: 0
          sysctl_set: yes
          reload: yes

      - name: Install ntp
        yum:
          name: ["ntp", "ntpdate", "ntp-doc"]
          state: present

      - name: Ensure ntp service starts
        service:
          name: ntpd
          enabled: yes
          state: started

      - name: Ensure limits are set
        lineinfile:
          path: /etc/security/limits.conf
          regexp: "^{{ item }}"
          line: "{{ item }}"
        with_items: limits

      - name: Extra Limit for RH Derived Distros
        lineinfile:
          path: /etc/security/limits.d/90-nproc.conf
          regexp: "^\\* – nproc 32768"
          line: "* – nproc 32768"
          create: yes

      - name: Get IP Address
        shell: "ip --4 address show eth1 | grep inet | awk '{ print $2; }' | cut -d '/' -f 1"
        register: ip_address

      - name: Add Cassandra Repository
        yum_repository:
          name: Cassandra
          description: Apache Cassandra Yum Repo
          baseurl: https://www.apache.org/dist/cassandra/redhat/311x/
          gpgcheck: 1
          repo_gpgcheck: 1
          gpgkey: https://www.apache.org/dist/cassandra/KEYS

      - name: Install Cassandra & Tools
        yum:
          name: [ "cassandra", "cassandra-tools", "python2-cassandra-driver" ]
          state: present
          update_cache: yes

      - name: Set Cassandra Cluster name
        lineinfile:
          dest: /etc/cassandra/conf/cassandra.yaml
          regexp: '^cluster_name:'
          line: "cluster_name: 'cassandra_cluster'"

      - name: Set Cassandra Seeds
        lineinfile:
          dest: /etc/cassandra/conf/cassandra.yaml
          regexp: '- seeds:'
          line: "        - seeds: \"192.168.44.101,192.168.44.102,192.168.44.103\""

      - name: Set Cassandra Listen Address
        lineinfile:
          dest: /etc/cassandra/conf/cassandra.yaml
          regexp: '^listen_address:'
          line: "listen_address: {{ ip_address.stdout }}"

      - name: Set Cassandra RPC Address
        lineinfile:
          dest: /etc/cassandra/conf/cassandra.yaml
          regexp: '^rpc_address:'
          line: "rpc_address: {{ ip_address.stdout }}"

      - name: Enable Cassandra service
        command: chkconfig cassandra on

      - name: Start Cassandra Service
        service:
          name: cassandra
          state: started

      - name: Set Cassandra authenticator
        lineinfile:
          dest: /etc/cassandra/conf/cassandra.yaml
          regexp: '^authenticator:'
          line: 'authenticator: PasswordAuthenticator'

      - name: Copy Cassandra Authentication Script to host
        copy: src="bash/cassandra_auth.sh" dest="/home/vagrant" mode=0100
        when: ansible_hostname == 'cnode1'

      - name: Execute Cassandra Authentication Script on the hosts
        command: "/home/vagrant/cassandra_auth.sh {{ cassandra_admin_user }} {{ cassandra_admin_user_pwd }}"
        when: ansible_hostname == 'cnode1'

#      - name: Run Casandra Authentication Setup Script
#        script: bash/cassandra_auth.sh {{ cassandra_admin_user }} {{ cassandra_admin_user_pwd }}
#        args:
#            creates: ansible_cassandra_admin_user_ran_here.txt
#        when: ansible_hostname == 'cnode1'
